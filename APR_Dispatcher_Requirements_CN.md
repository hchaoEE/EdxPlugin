# APR并行调度与监控系统需求文档（V1.0）

- 文档日期：2026-02-15
- 面向角色：芯片CAD工程师、EDA平台开发工程师、运维工程师
- 文档目标：在无商业调度器前提下，定义可落地的APR任务并行调度与监控系统需求

---

## 1. 背景与问题定义

当前APR任务通常通过人工在多台服务器上分发执行，存在以下痛点：

1. 任务分发效率低，手工操作易出错。
2. 多服务器资源使用不均衡，容易出现局部过载或空闲。
3. 对运行中的APR缺乏统一监控（进度、日志、关键QoR指标）。
4. 缺乏统一控制能力（暂停、恢复、终止、重跑、优先级调整）。
5. 失败任务排障慢，缺少结构化审计和历史追踪。

目标是在约5台服务器上，统一调度和管理约100个APR任务（运行中+排队中），并提供实时监控与控制能力。

---

## 2. 建设目标（业务目标）

### 2.1 总体目标

构建一个轻量、自主可控、可扩展的APR调度平台，替代手工分发方式，提升吞吐和可观测性。

### 2.2 量化目标（首版）

1. 支持5台服务器统一纳管。
2. 支持100个任务在途管理（排队+运行），并按资源自动控制实际并发。
3. 任务状态可视化延迟不超过5秒。
4. 关键控制操作（暂停/恢复/终止）响应不超过3秒（控制命令下发成功）。
5. 任务执行日志、关键结果文件、调度行为均可追溯。

---

## 3. 范围定义

## 3.1 In Scope（本期范围）

1. APR任务提交、排队、调度、执行、重试。
2. 多服务器资源管理（CPU/内存/磁盘/许可证配额/工具版本标签）。
3. APR任务生命周期监控与日志聚合。
4. APR任务控制：暂停、恢复、终止、重跑、优先级调整。
5. 结果归档与基础报表（成功率、平均耗时、失败原因分布）。
6. 基础权限与审计（谁提交、谁操作、何时操作）。

## 3.2 Out of Scope（本期不做）

1. 替代APR工具本身的算法能力。
2. 自研License Server（仅做许可证资源建模与调度约束）。
3. 跨机房/跨地域容灾（本期限定单机房内网）。
4. 全自动QoR优化闭环（本期保留人工判读+规则告警）。

---

## 4. 用户角色与典型场景

## 4.1 用户角色

1. CAD管理员：配置服务器、队列策略、资源配额和模板。
2. APR工程师：提交任务、查看进度、控制任务、下载结果。
3. 项目负责人：查看项目维度吞吐、成功率和资源使用报表。

## 4.2 典型场景

1. 批量提交：一次提交50~100个APR变体（参数扫描/脚本版本对比）。
2. 紧急插队：关键ECO任务需高优先级抢占排队任务。
3. 故障恢复：单机宕机后任务自动转移重试或失败可重跑。
4. 运行中诊断：实时查看日志和阶段（place/cts/route/signoff）定位卡点。

---

## 5. 总体架构（逻辑）

建议采用“控制面 + 执行面 + 观测面”三层：

1. 控制面（Control Plane）
   - API服务（任务提交/查询/控制）
   - 调度器（资源匹配、优先级、公平性、重试）
   - 元数据存储（任务、事件、状态、审计）

2. 执行面（Execution Plane）
   - 每台服务器部署Worker Agent
   - 负责拉取任务、启动APR进程、上报心跳/状态/日志
   - 实施本机资源隔离与并发限制

3. 观测面（Observability Plane）
   - 日志聚合（stdout/stderr、工具关键日志）
   - 指标监控（队列长度、任务耗时、机器负载）
   - 告警通知（任务失败、超时、机器失联）

---

## 6. 功能需求（Functional Requirements）

## 6.1 任务提交与模板管理

**FR-01 任务定义**
- 支持单任务提交和批量任务提交。
- 任务字段至少包括：项目名、设计名、流程模板、脚本路径、输入文件、输出目录、资源需求、优先级、超时。

**FR-02 流程模板**
- 支持APR流程模板（如place -> cts -> route -> signoff）。
- 支持模板参数化（工艺角、约束版本、开关参数）。

**FR-03 批量任务**
- 支持从CSV/YAML/JSON批量导入任务。
- 支持批量打标签（项目、版本、owner、实验编号）。

## 6.2 调度与资源管理

**FR-04 资源模型**
- 服务器资源：CPU核数、内存、磁盘、负载阈值。
- 工具资源：工具版本标签、许可证token配额（逻辑配额）。
- 队列资源：按项目/用户限制并发上限。

**FR-05 调度策略**
- 基础策略：优先级队列 + 资源约束匹配。
- 公平策略：同优先级下按项目或用户做公平轮转。
- 回填策略：高优任务等待时，可回填小任务提升利用率。

**FR-06 状态机**
- 状态：`CREATED -> QUEUED -> DISPATCHED -> RUNNING -> {SUCCESS | FAILED | CANCELLED | TIMEOUT}`。
- 支持`RETRYING`子状态，记录重试次数与原因。

## 6.3 运行监控与可视化

**FR-07 实时状态**
- 展示任务级状态、所在服务器、开始时间、运行时长、当前阶段。
- 5秒内刷新。

**FR-08 日志查看**
- 支持按任务实时查看stdout/stderr。
- 支持关键字过滤（error/warning/violations）。
- 支持日志下载与历史归档。

**FR-09 APR阶段与QoR快照**
- 从日志或report中解析阶段进度（place/cts/route/signoff）。
- 提取基础QoR指标（WNS/TNS/DRC数/功耗摘要）用于过程观测。

## 6.4 任务控制

**FR-10 控制动作**
- 支持暂停（若工具支持信号/检查点）、恢复、终止、重跑。
- 支持调整优先级和目标队列。

**FR-11 批量控制**
- 支持按筛选条件批量终止或批量重跑。
- 所有控制动作需记录审计日志（操作者、时间、原因）。

## 6.5 异常处理与恢复

**FR-12 失败重试**
- 支持自动重试（可配置次数、间隔、指数退避）。
- 支持按错误类型决定是否重试（如机器失联可重试，脚本语法错误不重试）。

**FR-13 超时与失联**
- 单任务超时后自动终止并标记`TIMEOUT`。
- Worker心跳丢失后任务进入`UNKNOWN`保护状态，触发告警和恢复策略。

## 6.6 结果管理与报表

**FR-14 结果归档**
- 归档关键输出：log、report、checkpoint、脚本快照。
- 支持按任务ID一键下载。

**FR-15 报表**
- 提供日/周维度报表：提交量、成功率、平均耗时、失败原因TopN、机器利用率。

## 6.7 权限与审计

**FR-16 权限模型**
- 最小角色：Admin / User / Viewer。
- 控制操作需鉴权。

**FR-17 审计追踪**
- 记录关键事件：提交、调度、控制、失败、重试、取消、配置变更。

---

## 7. 非功能需求（Non-Functional Requirements）

## 7.1 性能与容量

1. 支持100个在途任务（运行+排队）稳定管理。
2. 调度决策周期建议<=3秒（可配置）。
3. 监控页面状态更新延迟<=5秒。
4. 日志流式查看延迟目标<=2秒。

## 7.2 可靠性

1. 控制面服务可重启恢复，元数据不丢失。
2. 单Worker故障不影响其他服务器任务执行。
3. 关键操作幂等（重复点击“终止”不会产生脏状态）。

## 7.3 安全性

1. API鉴权（Token/LDAP二选一，首版可Token）。
2. 敏感配置（路径、凭据）脱敏存储与展示。
3. 审计日志不可篡改（至少追加写、定期归档）。

## 7.4 可维护性

1. 支持新增服务器的热注册或低停机接入。
2. 支持新增APR工具版本标签，无需改核心调度逻辑。
3. 关键模块有可观测指标与健康检查接口。

---

## 8. 数据模型（建议）

## 8.1 Job（任务）

- job_id
- project / design / owner
- template_id / params
- priority / queue
- resource_request（cpu/mem/disk/license/tool_version）
- status / retry_count / timeout_sec
- created_at / started_at / finished_at

## 8.2 Host（服务器）

- host_id / ip / labels
- total_cpu / total_mem / total_disk
- allocatable_cpu / allocatable_mem / allocatable_disk
- heartbeat_at / health_status

## 8.3 Execution（执行记录）

- exec_id / job_id / host_id
- pid / workdir / command
- current_stage
- exit_code / fail_reason

## 8.4 EventLog（事件日志）

- event_id / job_id / event_type
- operator / message / timestamp

---

## 9. 接口需求（最小集合）

## 9.1 API（示例）

1. `POST /jobs`：提交单任务
2. `POST /jobs/batch`：批量提交
3. `GET /jobs`：按条件查询任务
4. `GET /jobs/{id}`：任务详情
5. `GET /jobs/{id}/logs`：实时日志
6. `POST /jobs/{id}/pause`：暂停
7. `POST /jobs/{id}/resume`：恢复
8. `POST /jobs/{id}/stop`：终止
9. `POST /jobs/{id}/rerun`：重跑
10. `GET /hosts`：服务器资源状态
11. `GET /metrics/summary`：汇总报表

## 9.2 CLI（建议）

- `aprctl submit -f job.yaml`
- `aprctl list --project P1 --status RUNNING`
- `aprctl logs <job_id> -f`
- `aprctl stop <job_id>`
- `aprctl rerun <job_id> --from-stage route`

---

## 10. 调度策略细化（建议首版）

1. **硬约束优先**：先满足CPU/内存/许可证/工具版本。
2. **优先级调度**：P0 > P1 > P2。
3. **公平轮转**：同级任务在不同项目间轮转，防止单项目霸占。
4. **回填优化**：当高优任务因资源不足等待时，用小资源任务填充碎片资源。
5. **防雪崩控制**：同类失败（相同模板+错误码）达到阈值时自动熔断并告警。

---

## 11. 部署与技术选型建议（非强绑定）

可选开源技术组合：

1. API服务：FastAPI/Flask
2. 调度与队列：Celery/RQ/自研调度循环 + Redis
3. 元数据：PostgreSQL
4. 日志与监控：Loki + Promtail + Grafana（或ELK）
5. 指标采集：Prometheus + Node Exporter
6. Agent通信：HTTP/gRPC（二选一）

原则：首版优先“稳定可用+易维护”，避免过度设计。

---

## 12. 验收标准（UAT）

## 12.1 功能验收

1. 连续提交100个任务，系统可正确排队并调度执行。
2. 任意运行中任务可执行终止操作，并在3秒内显示控制已生效（命令下发成功）。
3. 模拟单台服务器故障，未完成任务可按策略重试或转失败可重跑。
4. 任意任务可追溯提交人、操作历史、日志和结果文件。

## 12.2 性能验收

1. 在100个在途任务下，页面状态刷新与API响应满足SLA（第7章）。
2. 连续24小时运行无调度服务崩溃和元数据损坏。

---

## 13. 实施里程碑（建议）

## M1（2~3周）：MVP

- 任务提交/查询/终止
- 基础调度（优先级+资源约束）
- Worker执行与心跳
- 日志采集与任务状态看板

## M2（2~3周）：增强

- 批量提交与模板参数化
- 自动重试、超时与告警
- 结果归档与基础报表

## M3（2周）：稳定化

- 公平轮转+回填策略
- 权限与审计完善
- 压测、故障演练、运维手册

---

## 14. 风险与应对

1. **许可证争用导致排队堆积**
   - 应对：将license token纳入资源约束，增加等待原因可视化。
2. **APR任务内存峰值不可预测**
   - 应对：引入历史画像与保守配额，超阈值自动隔离或降并发。
3. **日志量过大影响控制面性能**
   - 应对：日志异步采集、冷热分层存储、按需拉取。
4. **工具兼容性差异（暂停/恢复能力不一致）**
   - 应对：控制能力按工具分级实现，统一抽象并声明能力矩阵。

---

## 15. 待确认项（建议尽快拍板）

1. 100个任务是“100并发运行”还是“100在途（运行+排队）”？
2. 现网APR工具清单及版本（如Innovus/ICC2等）及其控制能力差异。
3. 单任务典型资源画像（CPU/内存/时长），用于并发上限配置。
4. 是否已有统一认证系统（LDAP/SSO），或首版先用Token。
5. 结果归档保留周期（如30天/90天）和存储预算。

---

## 16. 结论

以上需求定义了一个不依赖商业调度器、面向APR场景的实用平台：以“任务可控、过程可见、结果可追溯”为核心，先MVP落地，再逐步补齐公平调度、QoR观测和稳定性能力。

